generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Intent {
  INFORMATIONAL
  COMMERCIAL
  TRANSACTIONAL
  COMPARISON
}

model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
}

enum ContentStatus {
  PUBLISHED
  DRAFT
  PRIVATE
}

model Topic {
  id       Int           @id @default(autoincrement())
  name     String
  slug     String        @unique
  image    String?       // ADDED: Category Image
  status   ContentStatus @default(PUBLISHED)
  seoTitle String?
  seoDesc  String?
  posts    Post[]
  products Product[]     // ADDED: Relation to Product

  parentId Int?
  parent   Topic?  @relation("TopicHierarchy", fields: [parentId], references: [id])
  children Topic[] @relation("TopicHierarchy")
}

model Post {
  id           Int             @id @default(autoincrement())
  title        String
  slug         String          @unique
  excerpt      String?
  content      String
  gallery      String[]        @default([]) // ADDED: Multi-image gallery
  status       ContentStatus   @default(PUBLISHED)
  intent       Intent
  topicId      Int
  topic        Topic           @relation(fields: [topicId], references: [id])
  tags         PostTag[]
  affiliates   PostAffiliate[]
  schemaMarkup String?
  thumbnail    String?
  publishedAt  DateTime?
  createdAt    DateTime        @default(now())
}

model Product {
  id            Int           @id @default(autoincrement())
  name          String
  slug          String        @unique
  price         String?       // e.g. "15.000.000đ"
  originalPrice String?       // e.g. "20.000.000đ"
  description   String        // HTML content
  images        String[]      @default([]) // Slider images
  affiliateLink String?       // Buy Now URL
  specs         Json?         // Technical specifications { "Dimensions": "2x3m", "Material": "Leather" }
  rating        Float         @default(5.0)
  
  status        ContentStatus @default(PUBLISHED)
  
  topicId       Int
  topic         Topic         @relation(fields: [topicId], references: [id])
  
  brandId       Int?
  brand         Brand?        @relation(fields: [brandId], references: [id])
  
  comments      Comment[]
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  guestName String   // No login required
  productId Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}

model PostTag {
  postId Int
  tagId  Int

  post Post @relation(fields: [postId], references: [id])
  tag  Tag  @relation(fields: [tagId], references: [id])

  @@id([postId, tagId])
}

model Tag {
  id    Int       @id @default(autoincrement())
  name  String
  slug  String    @unique
  type  TagType
  posts PostTag[]
}

enum TagType {
  PRODUCT
  BRAND
  STYLE
  PROBLEM
  PRICE
}

model Affiliate {
  id     Int           @id @default(autoincrement())
  name   String
  brand  String?
  price  String?
  image  String?
  url    String
  status ContentStatus @default(PUBLISHED)

  brandId       Int?
  brandRelation Brand? @relation(fields: [brandId], references: [id])

  posts PostAffiliate[]
}

model Brand {
  id          Int           @id @default(autoincrement())
  name        String
  slug        String        @unique
  description String?
  logo        String?
  status      ContentStatus @default(PUBLISHED)
  affiliates  Affiliate[]
  products    Product[]     // ADDED: Relation to Product
}

model PostAffiliate {
  postId      Int
  affiliateId Int

  post      Post      @relation(fields: [postId], references: [id])
  affiliate Affiliate @relation(fields: [affiliateId], references: [id])

  @@id([postId, affiliateId])
}

model ClickLog {
  id          Int      @id @default(autoincrement())
  affiliateId Int
  url         String
  postId      Int?
  ip          String?
  userAgent   String?
  clickedAt   DateTime @default(now())

  @@index([affiliateId])
  @@index([clickedAt])
}
